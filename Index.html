<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Examination of Pronunciation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Custom Styles */
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #f0f4f8 0%, #e0e7ee 100%);
        }
        .main-card {
            background-color: #ffffff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .phonetic-text {
            font-family: 'Arial', 'Segoe UI', sans-serif;
            font-size: 1.6rem; 
            line-height: 2.8rem;
            color: #4338ca;
            background-color: #f5f3ff;
            padding: 1.5rem;
            border-radius: 0.75rem;
            text-align: left;
            white-space: normal;
        }
        .custom-input {
            border: 2px solid #e5e7eb;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .custom-input:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
        }
        /* Disabled state for button */
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        #videoPreview, #preCheckVideo {
            transform: scaleX(-1);
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-4xl main-card rounded-2xl p-6 md:p-12">
        
        <h1 class="text-4xl md:text-5xl font-extrabold text-center text-blue-900 mb-8">
            The Examination of Pronunciation
        </h1>

        <div id="statusMessage" class="hidden p-4 mb-6 rounded-xl text-base font-semibold transition-all duration-300" role="alert"></div>

        <div id="loginScreen" class="space-y-8">
            <h2 id="loginTitle" class="text-2xl font-semibold text-gray-700 text-center">Student Access</h2>
            
            <p id="loginInstructions" class="text-gray-600 text-center border-b pb-4">
                Please enter your complete password in the format: 
                <span class="font-bold text-indigo-600">Name, Place of Birth, Date of Birth</span>.
                <br>
                <span class="text-sm font-medium text-gray-500">(Example: Fajar Sadboy, Sumawa, May 31, 2007)</span>
                <span id="passwordWarning" class="block font-bold text-orange-600 mt-2">
                    IMPORTANT: This password can be used for up to <span id="maxUses">3</span> times.
                </span>
            </p>
            
            <input type="password" id="passwordInput" placeholder="Enter your full credentials here..." class="custom-input w-full p-4 rounded-xl focus:outline-none transition">
            
            <button id="loginButton" disabled class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-indigo-700 transition duration-200 shadow-lg hover:shadow-xl transform hover:scale-[1.01]">
                <div class="flex flex-col items-center justify-center text-center leading-tight">
                    <span id="loginBtnText" class="text-lg">Loading System...</span>
                    <span id="loginBtnSub" class="text-sm font-light opacity-80">Please wait for database connection</span>
                </div>
            </button>
            
            <button id="adminResetButton" class="w-full text-center text-sm font-medium text-gray-500 hover:text-indigo-600 transition pt-2">
                Reset Password Attempts (Admin)
            </button>
        </div>

        <div id="cameraPermissionScreen" class="hidden text-center space-y-8 p-8 rounded-xl border border-red-300 bg-red-50">
            <h2 class="text-3xl font-bold text-red-700">Camera & Microphone Access Required</h2>
            <p class="text-gray-700">
                Please allow access to your camera and microphone to continue.
            </p>
            <div class="mb-4 bg-gray-900 rounded-xl overflow-hidden shadow-2xl border-4 border-gray-700 mx-auto max-w-md">
                <video id="preCheckVideo" class="w-full h-auto" autoplay muted></video> 
            </div>
            <button id="cameraAccessButton" class="w-full max-w-sm mx-auto bg-red-700 text-white py-4 rounded-xl font-bold text-lg hover:bg-red-800 transition duration-200 shadow-xl transform hover:scale-[1.01]" disabled>
                <span>I'm Ready - Start Setup</span>
            </button>
        </div>
        
        <div id="readyScreen" class="hidden text-center space-y-8 p-8 rounded-xl border border-indigo-300 bg-indigo-50">
            <h2 id="readyTitle" class="text-3xl font-bold text-gray-800"></h2>
            <div id="transitionMessage" class="text-left space-y-6 text-gray-700"></div>
            <button id="startReadingButton" class="w-full max-w-sm mx-auto bg-indigo-700 text-white py-4 rounded-xl font-bold text-lg hover:bg-indigo-800 transition duration-200 shadow-xl transform hover:scale-[1.01]">
                <span>Start Reading</span>
            </button>
        </div>

        <div id="examScreen" class="hidden space-y-8">
            <div class="flex justify-between items-center pb-4 border-b border-gray-200">
                <h2 id="examTitle" class="text-3xl font-extrabold text-gray-800"></h2>
                <span id="partCounter" class="text-lg font-semibold text-indigo-600 bg-indigo-100 px-3 py-1 rounded-full shadow-inner">Part 1</span>
            </div>
            <div class="flex flex-col md:flex-row space-y-6 md:space-y-0 md:space-x-6">
                <div class="md:w-3/5 order-2 md:order-1">
                    <h3 class="text-xl font-semibold mb-3 text-gray-700">Text to Read:</h3>
                    <div id="readingContent" class="p-6 bg-gray-50 border border-gray-200 rounded-xl text-gray-800 text-lg leading-loose shadow-inner min-h-[200px] flex items-center justify-center"></div>
                </div>
                <div class="md:w-2/5 order-1 md:order-2 space-y-4">
                    <h3 class="text-xl font-semibold mb-2 text-gray-700">Video Preview:</h3>
                    <div class="bg-gray-900 rounded-xl overflow-hidden shadow-2xl border-4 border-gray-700">
                        <video id="videoPreview" class="w-full h-auto hidden" autoplay muted></video> 
                        <div id="videoPlaceholder" class="w-full h-36 md:h-48 flex items-center justify-center text-gray-400 font-medium" style="background-color: #2c3e50;">Live Camera Preview</div>
                    </div>
                    <div class="flex flex-col space-y-2 p-3 bg-white border border-gray-200 rounded-xl shadow-md">
                        <div class="flex justify-between items-center">
                            <span id="recordingStatus" class="text-sm font-medium text-gray-600">Ready to record.</span>
                            <span id="timerDisplay" class="text-3xl font-extrabold text-red-600 hidden">60s</span>
                        </div>
                    </div>
                    <button id="recordButton" class="bg-red-600 text-white py-3 rounded-xl font-bold hover:bg-red-700 transition duration-200 shadow-lg disabled:bg-gray-400">
                        <span>Stop Reading (Save Part)</span>
                    </button>
                </div>
            </div>
        </div>
        
        <div id="completionScreen" class="hidden text-center space-y-8 p-8 rounded-xl border border-green-400 bg-green-50">
            <h2 class="text-3xl font-bold text-green-700">Exam Complete!</h2>
            <div id="downloadList" class="space-y-6"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        async function init() {
            try {
                await setPersistence(auth, browserSessionPersistence);
                await signInAnonymously(auth);
                console.log("Firebase ready.");
                
                // PERBAIKAN: Enable tombol login setelah Firebase selesai load
                const btn = document.getElementById('loginButton');
                if(btn) {
                    btn.disabled = false;
                    document.getElementById('loginBtnText').textContent = "Start Examination";
                    document.getElementById('loginBtnSub').textContent = '"Start where you are, use what you have"';
                }
            } catch (error) {
                console.error("Auth Error:", error);
            }
        }
        init();

        // Expose to global scope
        window.firestoreDB = db;
        window.appId = appId;
        window.auth = auth; 
        window.doc = doc; 
        window.setDoc = setDoc; 
        window.getDoc = getDoc; 
        window.updateDoc = updateDoc;
        window.increment = increment;
    </script>
    
    <script>
        // --- CONFIG ---
        const EXAM_PART_DURATION = 60; 
        const MAX_USES = 3; 
        const ADMIN_RESET_KEY = "RESET_MASTER_KEY"; 
        
        const VALID_PASSWORDS = [
            "Fajar Sadboy, Sumawa, May 31, 2007",
            "Syarifah Zifa Putri Andini, Dumai, September 18, 2003",
            "Hasbi Ashidiqi Mardianto Ismaya, Garut, June 12, 2001",
            // ... (Tambahkan password lain di sini) ...
            "Hilman, Kediri, February 11, 2018"
        ];
        
        const READING_PARTS = [
            {
                title: "Part 1: Tongue Twister",
                content: `Betty Botter bought some butter. <br>But she said, "the butter’s bitter."`
            },
            {
                title: "Part 2: Phonetic Transcription",
                content: `<p class="phonetic-text">sæm ˈwɑntɪd tu lɜrn ˈɪŋɡlɪʃ fæst...</p>`
            },
            {
                title: "Part 3: English Reading Passage",
                content: `Sam wanted to learn English fast, so he followed a few tips...`
            }
        ];

        // --- STATE ---
        let currentPartIndex = 0;
        let recordingBlobs = [];
        let mediaRecorder, mediaStream, timerInterval;
        let timerSeconds = EXAM_PART_DURATION;
        let isRecording = false;
        let currentSanitizedPassword = '';
        let userName = '';
        let isAdminResetMode = false;

        const $ = (id) => document.getElementById(id);

        // Update UI for Max Uses
        if ($('maxUses')) $('maxUses').textContent = MAX_USES;

        // --- HELPERS ---
        function getPasswordStatusRef(passwordId) {
            return window.doc(window.firestoreDB, 'artifacts', window.appId, 'public', 'data', 'passwords_status', passwordId);
        }
        function getPublicDataRef(docId) {
            return window.doc(window.firestoreDB, 'artifacts', window.appId, 'public', 'data', 'exam_logs', docId);
        }
        function sanitizePassword(raw) {
            return raw.trim().toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_{2,}/g, '_');
        }
        function showMessage(msg, type) {
            const el = $('statusMessage');
            el.innerHTML = msg;
            el.className = `p-4 mb-6 rounded-xl font-bold ${type === 'error' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }
        function switchScreen(id) {
            ['loginScreen', 'cameraPermissionScreen', 'readyScreen', 'examScreen', 'completionScreen'].forEach(s => $(s).classList.add('hidden'));
            $(id).classList.remove('hidden');
        }

        // --- CORE LOGIC ---
        $('loginButton').addEventListener('click', async () => {
            const rawPassword = $('passwordInput').value.trim();
            
            // Safety Check: Ensure Firebase is loaded
            if (!window.getDoc) {
                showMessage('System still loading. Please wait 5 seconds and try again.', 'error');
                return;
            }

            if (isAdminResetMode) {
                // Admin Logic
                const [key, ...rest] = rawPassword.split(',');
                const target = rest.join(',').trim();
                if (key.trim() !== ADMIN_RESET_KEY || !target) {
                    showMessage('Invalid Admin Key or Target Password format.', 'error');
                    return;
                }
                try {
                    await window.setDoc(getPasswordStatusRef(sanitizePassword(target)), {
                        uses_remaining: MAX_USES,
                        reset_timestamp: new Date().toISOString()
                    }, { merge: true });
                    showMessage(`Reset Success: ${target} set to ${MAX_USES} uses.`, 'success');
                } catch (e) { showMessage('Reset Error.', 'error'); }
            } else {
                // Student Logic
                if (!VALID_PASSWORDS.includes(rawPassword)) {
                    showMessage('Invalid Password/Credentials.', 'error');
                    return;
                }
                
                currentSanitizedPassword = sanitizePassword(rawPassword);
                userName = rawPassword.split(',')[0].trim();
                const ref = getPasswordStatusRef(currentSanitizedPassword);

                try {
                    const snap = await window.getDoc(ref);
                    let remaining = MAX_USES;
                    if (snap.exists()) remaining = snap.data().uses_remaining ?? MAX_USES;

                    if (remaining <= 0) {
                        showMessage(`Login Failed: You have used all ${MAX_USES} attempts.`, 'error');
                        return;
                    }

                    // First time setup if needed
                    if (!snap.exists()) {
                        await window.setDoc(ref, {
                            raw_password: rawPassword,
                            student_name: userName,
                            uses_remaining: MAX_USES,
                            initial_use_timestamp: new Date().toISOString()
                        });
                    }

                    showMessage(`Welcome ${userName}! Attempts remaining: ${remaining}.`, 'success');
                    switchScreen('cameraPermissionScreen');
                    setupCamera();

                } catch (e) {
                    console.error(e);
                    showMessage('Database connection failed.', 'error');
                }
            }
        });

        // Admin Toggle
        $('adminResetButton').addEventListener('click', () => {
            isAdminResetMode = !isAdminResetMode;
            $('loginTitle').textContent = isAdminResetMode ? "Admin Reset Mode" : "Student Access";
            $('loginButton').className = isAdminResetMode 
                ? "w-full bg-red-600 text-white py-4 rounded-xl font-bold hover:bg-red-700 transition"
                : "w-full bg-indigo-600 text-white py-4 rounded-xl font-bold hover:bg-indigo-700 transition";
            $('loginBtnText').textContent = isAdminResetMode ? "Reset Password" : "Start Examination";
            $('passwordInput').placeholder = isAdminResetMode ? "AdminKey, Target Password" : "Enter credentials...";
        });

        // Camera Setup
        async function setupCamera() {
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                $('preCheckVideo').srcObject = mediaStream;
                $('videoPreview').srcObject = mediaStream;
                $('cameraAccessButton').disabled = false;
            } catch (e) {
                showMessage("Camera access denied.", 'error');
            }
        }

        // Start Exam Flow (Deducts Credit Here)
        $('cameraAccessButton').addEventListener('click', async () => {
            // DEDUCT CREDIT ONLY ONCE HERE
            try {
                await window.updateDoc(getPasswordStatusRef(currentSanitizedPassword), {
                    uses_remaining: window.increment(-1),
                    last_attempt: new Date().toISOString()
                });
            } catch (e) { console.error("Counter error", e); }

            currentPartIndex = 0;
            recordingBlobs = [];
            
            // Show Ready Screen
            $('readyTitle').textContent = `Welcome, ${userName}!`;
            $('transitionMessage').innerHTML = `<p>Camera ready. You have 60s per part.</p>`;
            $('startReadingButton').textContent = "Start Reading";
            $('startReadingButton').onclick = () => {
                switchScreen('examScreen');
                loadPart();
            };
            switchScreen('readyScreen');
        });

        // Load Part & Record
        function loadPart() {
            if (currentPartIndex >= READING_PARTS.length) return finishExam();
            
            const part = READING_PARTS[currentPartIndex];
            $('examTitle').textContent = part.title;
            $('readingContent').innerHTML = part.content;
            $('partCounter').textContent = `Part ${currentPartIndex + 1} of ${READING_PARTS.length}`;
            
            $('recordButton').disabled = false;
            $('recordButton').onclick = stopRecording;
            $('timerDisplay').classList.remove('hidden');
            
            startRecording();
        }

        function startRecording() {
            isRecording = true;
            mediaRecorder = new MediaRecorder(mediaStream, { mimeType: 'video/webm; codecs=vp9' });
            let chunks = [];
            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = () => {
                recordingBlobs.push(new Blob(chunks, { type: 'video/webm' }));
                currentPartIndex++;
                if (currentPartIndex < READING_PARTS.length) {
                    // Transition Logic
                    $('readyTitle').textContent = "Part Saved!";
                    $('transitionMessage').innerHTML = `<p>Proceed to next part.</p>`;
                    $('startReadingButton').textContent = "Next Part";
                    switchScreen('readyScreen');
                } else {
                    finishExam();
                }
            };
            mediaRecorder.start();
            
            timerSeconds = EXAM_PART_DURATION;
            $('timerDisplay').textContent = timerSeconds;
            timerInterval = setInterval(() => {
                timerSeconds--;
                $('timerDisplay').textContent = timerSeconds;
                if (timerSeconds <= 0) stopRecording();
            }, 1000);
        }

        function stopRecording() {
            if (isRecording) {
                isRecording = false;
                clearInterval(timerInterval);
                mediaRecorder.stop();
            }
        }

        async function finishExam() {
            if (mediaStream) mediaStream.getTracks().forEach(t => t.stop());
            
            // Save Log
            const logId = `log_${Date.now()}`;
            await window.setDoc(getPublicDataRef(logId), {
                user: userName,
                password: currentSanitizedPassword,
                parts: recordingBlobs.length,
                date: new Date().toISOString()
            });

            // Generate Downloads
            const list = $('downloadList');
            list.innerHTML = '';
            recordingBlobs.forEach((blob, i) => {
                const url = URL.createObjectURL(blob);
                list.innerHTML += `
                    <div class="p-4 bg-white rounded shadow border-green-200">
                        <p class="font-bold text-green-700">Part ${i+1}</p>
                        <video controls src="${url}" class="w-full mb-2"></video>
                        <a href="${url}" download="${userName}_Part${i+1}.webm" class="block w-full bg-green-600 text-white text-center py-2 rounded">Download</a>
                    </div>
                `;
            });
            switchScreen('completionScreen');
        }
    </script>
</body>
</html>